<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Tasks</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.3/css/bootstrap.min.css}" />
    <script th:src="@{/webjars/htmx.org/2.0.2/dist/htmx.min.js}"></script>
</head>
<body class="bg-light">
<div class="container py-4">
    <div class="d-flex align-items-center mb-3">
        <h1 class="h3 mb-0">Tasks</h1>
        <button class="btn btn-primary ms-auto" hx-get="/tasks/new" hx-target="#modal-body" hx-trigger="click" data-bs-toggle="modal" data-bs-target="#taskModal">New Task</button>
    </div>

    <!-- Toast container -->
    <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1080;"></div>

    <div id="task-list" hx-get="/tasks/list" hx-trigger="load" hx-target="#task-list" hx-swap="outerHTML"></div>
</div>

<div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modal-body">
      </div>
    </div>
  </div>
</div>

<script th:src="@{/webjars/bootstrap/5.3.3/js/bootstrap.bundle.min.js}"></script>
<script>
  const makeToast = (message, type) => {
    const container = document.getElementById('toast-container');
    if (!container) return;
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type || 'success'} border-0`;
    toast.setAttribute('role','alert');
    toast.setAttribute('aria-live','assertive');
    toast.setAttribute('aria-atomic','true');
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>`;
    toast.querySelector('.toast-body').textContent = message || '';
    container.appendChild(toast);
    const t = new bootstrap.Toast(toast, { autohide: true, delay: 3000 });
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
    t.show();
  };

  const handleHxTrigger = (evt) => {
    const hdr = evt.detail && evt.detail.xhr && evt.detail.xhr.getResponseHeader('HX-Trigger');
    if (!hdr) return;
    try {
      const data = JSON.parse(hdr);
      if (data.toast && data.toast.message) {
        makeToast(data.toast.message, data.toast.type || 'success');
      }
    } catch(e) {
      console.warn('HX-Trigger parse failed', e);
    }
  };

  // Close modal when task list gets refreshed via HTMX
  document.body.addEventListener('htmx:afterSwap', function(evt) {
    const target = evt.detail && evt.detail.target;
    if (target && target.id === 'task-list') {
      const modalEl = document.getElementById('taskModal');
      if (modalEl) {
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) { modal.hide(); }
      }
    }
  });

  // Handle HX-Trigger once per request
  document.body.addEventListener('htmx:afterOnLoad', function(evt) {
    handleHxTrigger(evt);
  });

  // Show toast on HTMX response errors (e.g., validation 400)
  document.body.addEventListener('htmx:responseError', function(evt) {
    const container = document.getElementById('toast-container');
    if (!container) return;
    const wrapper = document.createElement('div');
    wrapper.innerHTML = evt.detail.xhr.response;
    // Only initialize newly appended toasts
    const newNodes = Array.from(wrapper.childNodes);
    container.append(...newNodes);
    newNodes.forEach(el => {
      if (el.classList && el.classList.contains('toast')) {
        const t = new bootstrap.Toast(el, { autohide: true, delay: 3000 });
        el.addEventListener('hidden.bs.toast', () => el.remove());
        t.show();
      }
    });
  });

  // Comment editing functions
  document.body.addEventListener('click', function(e) {
    if (e.target.classList.contains('edit-comment-btn')) {
      editComment(e.target);
    }
  });

  function editComment(btn) {
    const commentDiv = btn.closest('[id^="comment-"]');
    if (!commentDiv) return;

    const commentId = commentDiv.id.replace('comment-', '');
    const contentEl = document.getElementById('comment-content-' + commentId);
    if (!contentEl) return;

    const originalContent = contentEl.textContent.trim();

    const textarea = document.createElement('textarea');
    textarea.className = 'form-control form-control-sm mb-2';
    textarea.id = 'edit-text-' + commentId;
    textarea.style.minHeight = '60px';
    textarea.value = originalContent;

    const saveBtn = document.createElement('button');
    saveBtn.type = 'button';
    saveBtn.className = 'btn btn-sm btn-primary me-2';
    saveBtn.textContent = 'Save';
    saveBtn.onclick = function() { saveComment(commentId, originalContent); };

    const cancelBtn = document.createElement('button');
    cancelBtn.type = 'button';
    cancelBtn.className = 'btn btn-sm btn-secondary';
    cancelBtn.textContent = 'Cancel';
    cancelBtn.onclick = function() { cancelEdit(commentId, originalContent); };

    const buttonDiv = document.createElement('div');
    buttonDiv.className = 'gap-2 d-flex';
    buttonDiv.appendChild(saveBtn);
    buttonDiv.appendChild(cancelBtn);

    contentEl.innerHTML = '';
    contentEl.appendChild(textarea);
    contentEl.appendChild(buttonDiv);
    textarea.focus();
  }

  function cancelEdit(commentId, originalContent) {
    const contentEl = document.getElementById('comment-content-' + commentId);
    if (contentEl) {
      contentEl.textContent = originalContent;
    }
  }

  function saveComment(commentId, originalContent) {
    const textarea = document.getElementById('edit-text-' + commentId);
    if (!textarea) return;

    const newContent = textarea.value.trim();
    if (!newContent) {
      alert('Comment cannot be empty');
      return;
    }

    // Get task ID from the modal or URL
    const modal = document.getElementById('taskModal');
    const taskId = modal ? modal.getAttribute('data-task-id') : null;

    if (!taskId) {
      console.error('Task ID not found');
      return;
    }

    // Send update to server
    fetch(`/tasks/${taskId}/comments/${commentId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: 'content=' + encodeURIComponent(newContent)
    })
    .then(response => {
      if (response.ok) {
        const contentEl = document.getElementById('comment-content-' + commentId);
        if (contentEl) {
          contentEl.textContent = newContent;
        }
        makeToast('Comment updated successfully', 'success');
      } else {
        alert('Failed to save comment');
        // Restore original content
        const contentEl = document.getElementById('comment-content-' + commentId);
        if (contentEl) {
          contentEl.textContent = originalContent;
        }
      }
    })
    .catch(err => {
      console.error('Error saving comment:', err);
      alert('Error saving comment');
      const contentEl = document.getElementById('comment-content-' + commentId);
      if (contentEl) {
        contentEl.textContent = originalContent;
      }
    });
  }

  function addReaction(btnOrEvent, emoji) {
    // Handle both direct button click (btnOrEvent = button element) and event-based click (btnOrEvent = event)
    let btn = btnOrEvent;
    if (btnOrEvent && btnOrEvent.target) {
      // It's an event object
      btn = btnOrEvent.target;
    }

    // Get task ID and comment ID from DOM
    const modal = document.getElementById('taskModal');
    const taskId = modal ? modal.getAttribute('data-task-id') : null;

    // Find the comment container - look for the exact pattern: id="comment-" followed by UUID (no hyphens in between)
    // We need to traverse up to find the main comment div, not the reactions display div
    let commentDiv = btn.closest('div[id^="comment-"]:not([id*="reactions"])');

    // If that doesn't work, try finding any parent with comment- ID and extracting properly
    if (!commentDiv) {
      let parent = btn.parentElement;
      while (parent) {
        if (parent.id && parent.id.startsWith('comment-') && !parent.id.includes('reactions')) {
          commentDiv = parent;
          break;
        }
        parent = parent.parentElement;
      }
    }

    if (!commentDiv) {
      console.error('Could not find comment container');
      return;
    }

    // Extract just the UUID part (remove "comment-" prefix)
    const commentId = commentDiv.id.substring(8); // "comment-" is 8 chars

    if (!taskId || !commentId) {
      console.error('Missing taskId or commentId', { taskId, commentId, divId: commentDiv.id });
      return;
    }

    console.log('Adding reaction:', { taskId, commentId, emoji });

    // Send to server
    fetch(`/tasks/${taskId}/comments/${commentId}/reactions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: 'emoji=' + encodeURIComponent(emoji)
    })
    .then(response => {
      if (response.ok) {
        // Reload the entire activity section to get fresh reactions
        htmx.ajax('GET', `/tasks/${taskId}`, '#task-activity');
      } else {
        console.error('Failed to save reaction, status:', response.status);
      }
    })
    .catch(err => {
      console.error('Error saving reaction:', err);
    });
  }
</script>
</body>
</html>
