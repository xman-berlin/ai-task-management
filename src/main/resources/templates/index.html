<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Tasks</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.3/css/bootstrap.min.css}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <script th:src="@{/webjars/htmx.org/2.0.2/dist/htmx.min.js}"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #f093fb;
            --danger-color: #ff6b6b;
            --success-color: #51cf66;
            --bg-color: #f8f9fa;
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        body {
            background: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        .navbar-header {
            background: white;
            box-shadow: var(--card-shadow);
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }

        .navbar-header h1 {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            font-size: 1.8rem;
        }

        .btn-new-task {
            background: var(--primary-gradient);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-new-task:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
            color: white;
        }

        .btn-new-task i {
            margin-right: 0.5rem;
        }

        .modal-content {
            border: none;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }

        .modal-header {
            background: var(--primary-gradient);
            border-radius: 12px 12px 0 0;
            color: white;
            border: none;
        }

        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }

        .btn-primary {
            background: var(--primary-color);
            border: none;
            border-radius: 8px;
            padding: 0.6rem 1.2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger-color);
            border: none;
            border-radius: 8px;
        }

        .btn-danger:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }

        .btn-sm {
            border-radius: 6px;
        }

        .btn-outline-secondary {
            border-color: #dee2e6;
            color: #495057;
        }

        .btn-outline-secondary:hover {
            background: #f8f9fa;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .badge {
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            font-weight: 600;
        }

        .edit-comment-btn, .delete-btn {
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .edit-comment-btn:hover {
            transform: scale(1.05);
        }

        .delete-btn:hover {
            transform: scale(1.05);
        }

        .toast {
            border-radius: 8px;
            border: none;
            box-shadow: var(--card-shadow);
        }

        .text-bg-success {
            background: var(--success-color) !important;
        }

        .text-bg-danger {
            background: var(--danger-color) !important;
        }

        .text-bg-warning {
            background: #ffa94d !important;
        }

        form .form-control, form .form-select {
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        form .form-control:focus, form .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        form .form-label {
            color: #333;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="bg-light">
<div class="navbar-header">
    <div class="container">
        <div class="d-flex align-items-center justify-content-between">
            <h1 class="mb-0"><i class="bi bi-check2-circle"></i> Tasks</h1>
            <button class="btn btn-new-task" hx-get="/tasks/new" hx-target="#modal-body" hx-trigger="click" data-bs-toggle="modal" data-bs-target="#taskModal">
                <i class="bi bi-plus-circle"></i> New Task
            </button>
        </div>
    </div>
</div>

<div class="container">
    <!-- Toast container -->
    <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1080;"></div>

    <div id="task-list" hx-get="/tasks/list" hx-trigger="load" hx-target="#task-list" hx-swap="outerHTML"></div>
</div>

<div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modal-body">
      </div>
    </div>
  </div>
</div>

<script th:src="@{/webjars/bootstrap/5.3.3/js/bootstrap.bundle.min.js}"></script>
<script>
  const makeToast = (message, type) => {
    const container = document.getElementById('toast-container');
    if (!container) return;
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type || 'success'} border-0`;
    toast.setAttribute('role','alert');
    toast.setAttribute('aria-live','assertive');
    toast.setAttribute('aria-atomic','true');
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>`;
    toast.querySelector('.toast-body').textContent = message || '';
    container.appendChild(toast);
    const t = new bootstrap.Toast(toast, { autohide: true, delay: 3000 });
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
    t.show();
  };

  const handleHxTrigger = (evt) => {
    const hdr = evt.detail && evt.detail.xhr && evt.detail.xhr.getResponseHeader('HX-Trigger');
    if (!hdr) return;
    try {
      const data = JSON.parse(hdr);
      if (data.toast && data.toast.message) {
        makeToast(data.toast.message, data.toast.type || 'success');
      }
    } catch(e) {
      console.warn('HX-Trigger parse failed', e);
    }
  };

  // Close modal when task list gets refreshed via HTMX
  document.body.addEventListener('htmx:afterSwap', function(evt) {
    const target = evt.detail && evt.detail.target;
    if (target && target.id === 'task-list') {
      const modalEl = document.getElementById('taskModal');
      if (modalEl) {
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) { modal.hide(); }
      }
    }
  });

  // Handle HX-Trigger once per request
  document.body.addEventListener('htmx:afterOnLoad', function(evt) {
    handleHxTrigger(evt);
  });

  // Show toast on HTMX response errors (e.g., validation 400)
  document.body.addEventListener('htmx:responseError', function(evt) {
    const container = document.getElementById('toast-container');
    if (!container) return;
    const wrapper = document.createElement('div');
    wrapper.innerHTML = evt.detail.xhr.response;
    // Only initialize newly appended toasts
    const newNodes = Array.from(wrapper.childNodes);
    container.append(...newNodes);
    newNodes.forEach(el => {
      if (el.classList && el.classList.contains('toast')) {
        const t = new bootstrap.Toast(el, { autohide: true, delay: 3000 });
        el.addEventListener('hidden.bs.toast', () => el.remove());
        t.show();
      }
    });
  });

  // Comment editing functions
  document.body.addEventListener('click', function(e) {
    const btn = e.target.closest('.edit-comment-btn');
    if (btn) {
      editComment(btn);
    }
  });

  function editComment(btn) {
    const commentDiv = btn.closest('[id^="comment-"]');
    if (!commentDiv) return;

    const commentId = commentDiv.id.replace('comment-', '');
    const contentEl = document.getElementById('comment-content-' + commentId);
    if (!contentEl) return;

    const originalContent = contentEl.textContent.trim();

    const textarea = document.createElement('textarea');
    textarea.className = 'form-control form-control-sm mb-2';
    textarea.id = 'edit-text-' + commentId;
    textarea.style.display = 'block';
    textarea.style.minHeight = '100px';
    textarea.style.width = '100%';
    textarea.style.color = '#212529';
    textarea.style.background = '#fff';
    textarea.style.caretColor = '#000';
    textarea.style.border = '1px solid #0d6efd';
    textarea.style.borderRadius = '6px';
    textarea.style.padding = '0.5rem';
    textarea.style.outline = 'none';
    textarea.style.boxShadow = '0 0 0 0.2rem rgba(13,110,253,.25)';
    textarea.style.zIndex = '1';
    textarea.value = originalContent;
    textarea.readOnly = false;
    textarea.disabled = false;
    textarea.autofocus = true;
    textarea.setAttribute('aria-label', 'Edit comment');

    const saveBtn = document.createElement('button');
    saveBtn.type = 'button';
    saveBtn.className = 'btn btn-sm btn-primary me-2';
    saveBtn.textContent = 'Save';
    saveBtn.onclick = function() { saveComment(commentId, originalContent); };

    const cancelBtn = document.createElement('button');
    cancelBtn.type = 'button';
    cancelBtn.className = 'btn btn-sm btn-secondary';
    cancelBtn.textContent = 'Cancel';
    cancelBtn.onclick = function() { cancelEdit(commentId, originalContent); };

    const buttonDiv = document.createElement('div');
    buttonDiv.className = 'gap-2 d-flex';
    buttonDiv.appendChild(saveBtn);
    buttonDiv.appendChild(cancelBtn);

    contentEl.innerHTML = '';
    contentEl.appendChild(textarea);
    contentEl.appendChild(buttonDiv);
    textarea.focus();
    textarea.selectionStart = textarea.value.length;
  }

  function cancelEdit(commentId, originalContent) {
    const contentEl = document.getElementById('comment-content-' + commentId);
    if (contentEl) {
      contentEl.textContent = originalContent;
    }
  }

  function saveComment(commentId, originalContent) {
    const textarea = document.getElementById('edit-text-' + commentId);
    if (!textarea) return;

    const newContent = textarea.value.trim();
    if (!newContent) {
      alert('Comment cannot be empty');
      return;
    }

    // Get task ID from the modal or URL
    const modal = document.getElementById('taskModal');
    const taskId = modal ? modal.getAttribute('data-task-id') : null;

    if (!taskId) {
      console.error('Task ID not found');
      return;
    }

    // Send update to server
    fetch(`/tasks/${taskId}/comments/${commentId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: 'content=' + encodeURIComponent(newContent)
    })
    .then(response => {
      if (response.ok) {
        const contentEl = document.getElementById('comment-content-' + commentId);
        if (contentEl) {
          contentEl.textContent = newContent;
        }
        makeToast('Comment updated successfully', 'success');
      } else {
        alert('Failed to save comment');
        // Restore original content
        const contentEl = document.getElementById('comment-content-' + commentId);
        if (contentEl) {
          contentEl.textContent = originalContent;
        }
      }
    })
    .catch(err => {
      console.error('Error saving comment:', err);
      alert('Error saving comment');
      const contentEl = document.getElementById('comment-content-' + commentId);
      if (contentEl) {
        contentEl.textContent = originalContent;
      }
    });
  }

  function addReaction(btnOrEvent, emoji) {
    // Handle both direct button click (btnOrEvent = button element) and event-based click (btnOrEvent = event)
    let btn = btnOrEvent;
    if (btnOrEvent && btnOrEvent.target) {
      // It's an event object
      btn = btnOrEvent.target;
    }

    // Get task ID and comment ID from DOM
    const modal = document.getElementById('taskModal');
    const taskId = modal ? modal.getAttribute('data-task-id') : null;

    // Find the comment container - look for the exact pattern: id="comment-" followed by UUID (no hyphens in between)
    // We need to traverse up to find the main comment div, not the reactions display div
    let commentDiv = btn.closest('div[id^="comment-"]:not([id*="reactions"])');

    // If that doesn't work, try finding any parent with comment- ID and extracting properly
    if (!commentDiv) {
      let parent = btn.parentElement;
      while (parent) {
        if (parent.id && parent.id.startsWith('comment-') && !parent.id.includes('reactions')) {
          commentDiv = parent;
          break;
        }
        parent = parent.parentElement;
      }
    }

    if (!commentDiv) {
      console.error('Could not find comment container');
      return;
    }

    // Extract just the UUID part (remove "comment-" prefix)
    const commentId = commentDiv.id.substring(8); // "comment-" is 8 chars

    if (!taskId || !commentId) {
      console.error('Missing taskId or commentId', { taskId, commentId, divId: commentDiv.id });
      return;
    }

    console.log('Adding reaction:', { taskId, commentId, emoji });

    // Send to server
    fetch(`/tasks/${taskId}/comments/${commentId}/reactions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: 'emoji=' + encodeURIComponent(emoji)
    })
    .then(response => {
      if (response.ok) {
        // Reload the entire activity section to get fresh reactions
        htmx.ajax('GET', `/tasks/${taskId}`, '#task-activity');
      } else {
        console.error('Failed to save reaction, status:', response.status);
      }
    })
    .catch(err => {
      console.error('Error saving reaction:', err);
    });
  }
</script>
</body>
</html>
