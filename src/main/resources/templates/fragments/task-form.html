<div th:fragment="form">
    <form th:object="${task}"
          th:attr="hx-post=${task.id} == null ? '/tasks' : @{/tasks/{id}(id=${task.id})}"
          hx-target="#task-list"
          hx-swap="outerHTML"
          hx-on="htmx:afterSwap: closeTaskModal()">
        <input type="hidden" th:field="*{id}" />
        <div class="mb-4">
            <label class="form-label"><i class="bi bi-type"></i> Title</label>
            <input id="task-title" class="form-control" type="text" th:field="*{title}" required maxlength="255" placeholder="Enter task title" />
        </div>
        <div class="mb-4">
            <label class="form-label d-flex align-items-center justify-content-between">
                <span><i class="bi bi-file-text"></i> Description</span>
                <button type="button" class="btn btn-sm btn-outline-primary" id="ai-decompose-btn" onclick="decomposeTask()" style="border-radius: 6px;">
                    <i class="bi bi-lightning-charge"></i> AI Decompose
                </button>
            </label>
            <textarea id="task-description" class="form-control" rows="3" maxlength="4000" th:field="*{description}" placeholder="Add task details..."></textarea>
            <small id="ai-decompose-note" class="form-text text-muted" style="display:none;"></small>
        </div>
        <div class="row mb-4">
            <div class="col">
                <label class="form-label d-flex align-items-center justify-content-between">
                    <span><i class="bi bi-exclamation-circle"></i> Priority</span>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="ai-suggest-btn" onclick="suggestPriority()" style="border-radius: 6px;">
                        <i class="bi bi-lightbulb"></i> AI Suggest
                    </button>
                </label>
                <select id="task-priority" class="form-select" th:field="*{priority}">
                    <option value="LOW"><i class="bi bi-info-circle"></i> Low</option>
                    <option value="MEDIUM"><i class="bi bi-exclamation-triangle"></i> Medium</option>
                    <option value="HIGH"><i class="bi bi-exclamation-circle-fill"></i> High</option>
                </select>
                <small id="ai-rationale" class="form-text text-muted" style="display:none;"></small>
            </div>
            <div class="col">
                <label class="form-label"><i class="bi bi-circle-half"></i> Status</label>
                <select class="form-select" th:field="*{status}">
                    <option value="TODO">To Do</option>
                    <option value="IN_PROGRESS">In Progress</option>
                    <option value="DONE">Done</option>
                </select>
            </div>
            <div class="col">
                <label class="form-label d-flex align-items-center justify-content-between">
                    <span><i class="bi bi-calendar-check"></i> Due Date</span>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="ai-deadline-btn" onclick="suggestDeadline()" style="border-radius: 6px;">
                        <i class="bi bi-clock-history"></i> AI Deadline
                    </button>
                </label>
                <input id="task-duedate" class="form-control" type="datetime-local" name="dueDate"
                       th:value="${task.dueDate != null ? #temporals.format(task.dueDate, 'yyyy-MM-dd''T''HH:mm') : ''}" />
                <small id="ai-deadline-note" class="form-text text-muted" style="display:none;"></small>
            </div>
        </div>
        <div class="d-flex justify-content-end gap-2 mt-4 pt-4 border-top">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 8px; border: none;">
                <i class="bi bi-x-circle"></i> Close
            </button>
            <button type="submit" class="btn btn-primary" style="border-radius: 8px; border: none;">
                <i class="bi bi-check-circle-fill"></i> Save
            </button>
        </div>
    </form>

    <!-- Activity Log & Comments -->
    <div th:if="${task.id}" class="mt-4">
        <div th:replace="fragments/task-activity :: activity"></div>
    </div>

    <script>
    function asIsoLocal(datetimeStr) {
        // Accepts ISO string from backend and returns yyyy-MM-ddTHH:mm for input[type=datetime-local]
        try {
            const d = new Date(datetimeStr);
            const pad = n => String(n).padStart(2, '0');
            const yyyy = d.getFullYear();
            const MM = pad(d.getMonth() + 1);
            const dd = pad(d.getDate());
            const hh = pad(d.getHours());
            const mm = pad(d.getMinutes());
            return `${yyyy}-${MM}-${dd}T${hh}:${mm}`;
        } catch (_) { return ''; }
    }

    function suggestPriority() {
        const btn = document.getElementById('ai-suggest-btn');
        const priorityField = document.getElementById('task-priority');
        const rationaleField = document.getElementById('ai-rationale');

        const title = document.getElementById('task-title').value;
        const description = document.getElementById('task-description').value;
        const dueDate = document.getElementById('task-duedate').value;

        if (!title) { alert('Please enter a task title first'); return; }

        btn.disabled = true;
        btn.textContent = 'Thinking...';

        fetch('/api/ai/prioritize', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, description, dueDate })
        })
        .then(res => res.json())
        .then(data => {
            priorityField.value = data.priority;
            rationaleField.textContent = 'üí° ' + (data.rationale || 'AI suggestion applied');
            rationaleField.style.display = 'block';
        })
        .catch(err => { alert('AI suggestion failed: ' + err.message); })
        .finally(() => { btn.disabled = false; btn.textContent = 'üí° AI Suggest'; });
    }

    function decomposeTask() {
        const btn = document.getElementById('ai-decompose-btn');
        const descriptionField = document.getElementById('task-description');
        const note = document.getElementById('ai-decompose-note');

        const title = document.getElementById('task-title').value;
        const description = descriptionField.value;
        const dueDate = document.getElementById('task-duedate').value;

        if (!title) { alert('Please enter a task title first'); return; }

        btn.disabled = true; btn.textContent = 'Thinking...';
        fetch('/api/ai/decompose', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, description, dueDate })
        })
        .then(res => res.json())
        .then(data => {
            const subtasks = Array.isArray(data.subtasks) ? data.subtasks : [];
            if (subtasks.length) {
                const bullets = '\n' + subtasks.map(s => '- ' + s).join('\n');
                // Append bullet list to description (preserve existing content)
                descriptionField.value = (descriptionField.value || '') + bullets;
                note.textContent = 'üîß AI subtasks inserted into description.';
                note.style.display = 'block';
            } else {
                alert('AI did not return subtasks.');
            }
        })
        .catch(err => { alert('AI decomposition failed: ' + err.message); })
        .finally(() => { btn.disabled = false; btn.textContent = 'üîß AI Decompose'; });
    }

    function suggestDeadline() {
        const btn = document.getElementById('ai-deadline-btn');
        const dueField = document.getElementById('task-duedate');
        const note = document.getElementById('ai-deadline-note');

        const title = document.getElementById('task-title').value;
        const description = document.getElementById('task-description').value;

        if (!title) { alert('Please enter a task title first'); return; }

        btn.disabled = true; btn.textContent = 'Thinking...';
        fetch('/api/ai/deadline', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, description })
        })
        .then(res => res.json())
        .then(data => {
            const iso = data.suggestedDueDate || data.suggested || data.date;
            const display = asIsoLocal(iso);
            if (display) {
                dueField.value = display;
                note.textContent = '‚è±Ô∏è ' + (data.rationale || 'AI suggested a realistic deadline');
                note.style.display = 'block';
            } else {
                alert('AI did not return a valid date.');
            }
        })
        .catch(err => { alert('AI deadline failed: ' + err.message); })
        .finally(() => { btn.disabled = false; btn.textContent = '‚è±Ô∏è AI Deadline'; });
    }

    function closeTaskModal() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('taskModal'));
        if (modal) modal.hide();
    }

    // Set task ID on modal for comment editing
    document.addEventListener('DOMContentLoaded', function() {
        const taskIdInput = document.querySelector('input[name="id"]');
        if (taskIdInput && taskIdInput.value) {
            document.getElementById('taskModal').setAttribute('data-task-id', taskIdInput.value);
        }
    });

    // Also set it when form is loaded via HTMX
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        const taskIdInput = document.querySelector('input[name="id"]');
        if (taskIdInput && taskIdInput.value) {
            document.getElementById('taskModal').setAttribute('data-task-id', taskIdInput.value);
        }
    });
    </script>
</div>
