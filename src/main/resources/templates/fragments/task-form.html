<div th:fragment="form">
    <form th:object="${task}"
          th:attr="hx-post=${task.id} == null ? '/tasks' : @{/tasks/{id}(id=${task.id})}"
          hx-target="#task-list"
          hx-swap="outerHTML">
        <input type="hidden" th:field="*{id}" />
        <div class="mb-3">
            <label class="form-label">Title</label>
            <input id="task-title" class="form-control" type="text" th:field="*{title}" required maxlength="255" />
        </div>
        <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea id="task-description" class="form-control" rows="3" maxlength="4000" th:field="*{description}"></textarea>
        </div>
        <div class="row mb-3">
            <div class="col">
                <label class="form-label d-flex align-items-center justify-content-between">
                    <span>Priority</span>
                    <button type="button" class="btn btn-sm btn-outline-info" id="ai-suggest-btn" onclick="suggestPriority()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                            <path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.437 10.437 0 0 1-.524 2.318l-.003.011a10.722 10.722 0 0 1-.244.637c-.079.186.074.394.273.362a21.673 21.673 0 0 0 .693-.125zm.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6c0 3.193-3.004 6-7 6a8.06 8.06 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a10.97 10.97 0 0 0 .398-2z"/>
                        </svg>
                        AI Suggest
                    </button>
                </label>
                <select id="task-priority" class="form-select" th:field="*{priority}">
                    <option value="LOW">LOW</option>
                    <option value="MEDIUM">MEDIUM</option>
                    <option value="HIGH">HIGH</option>
                </select>
                <small id="ai-rationale" class="form-text text-muted" style="display:none;"></small>
            </div>
            <div class="col">
                <label class="form-label">Status</label>
                <select class="form-select" th:field="*{status}">
                    <option value="TODO">TODO</option>
                    <option value="IN_PROGRESS">IN_PROGRESS</option>
                    <option value="DONE">DONE</option>
                </select>
            </div>
            <div class="col">
                <label class="form-label">Due Date</label>
                <input id="task-duedate" class="form-control" type="datetime-local" name="dueDate"
                       th:value="${task.dueDate != null ? #temporals.format(task.dueDate, 'yyyy-MM-dd''T''HH:mm') : ''}" />
            </div>
        </div>
        <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save</button>
        </div>
    </form>

    <script>
    function suggestPriority() {
        const btn = document.getElementById('ai-suggest-btn');
        const priorityField = document.getElementById('task-priority');
        const rationaleField = document.getElementById('ai-rationale');

        const title = document.getElementById('task-title').value;
        const description = document.getElementById('task-description').value;
        const dueDate = document.getElementById('task-duedate').value;

        if (!title) {
            alert('Please enter a task title first');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Thinking...';

        fetch('/api/ai/prioritize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, description, dueDate })
        })
        .then(res => res.json())
        .then(data => {
            priorityField.value = data.priority;
            rationaleField.textContent = 'ðŸ’¡ AI: ' + data.rationale;
            rationaleField.style.display = 'block';
            btn.disabled = false;
            btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/><path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.437 10.437 0 0 1-.524 2.318l-.003.011a10.722 10.722 0 0 1-.244.637c-.079.186.074.394.273.362a21.673 21.673 0 0 0 .693-.125zm.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6c0 3.193-3.004 6-7 6a8.06 8.06 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a10.97 10.97 0 0 0 .398-2z"/></svg> AI Suggest';
        })
        .catch(err => {
            alert('AI suggestion failed: ' + err.message);
            btn.disabled = false;
            btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/><path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.437 10.437 0 0 1-.524 2.318l-.003.011a10.722 10.722 0 0 1-.244.637c-.079.186.074.394.273.362a21.673 21.673 0 0 0 .693-.125zm.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6c0 3.193-3.004 6-7 6a8.06 8.06 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a10.97 10.97 0 0 0 .398-2z"/></svg> AI Suggest';
        });
    }
    </script>
</div>
